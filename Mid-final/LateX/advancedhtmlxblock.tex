\chapter{Advanced HTML XBlock for Open edX platform}

\section{Features}
\begin{itemize}
	\item Full CSS Support
	\item JavaScript Suppport
	\item Live Preview HTML
	\item Code Indentation
	\item Code Folding
	\item Autocomplete Tags
	\item Autocomplete Brackets
	\item Supports all HTML tags
\end{itemize}

\section{Installation}
Installation instructions are already covered in previous chapters(Creating an Xblock)\newline
\textbf{Special Note for Docker based devstack :}\newline
Since the docker based devstack has two separate containers for lms and studio, it is required that you
install this xblock in both the containers and then [re]start both lms and studio to see changes.
The workflow would look something like this :
\begin{enumerate}
	\item \verb= make studio-shell=
	\item Install xblock as mentioned before
	\item \verb=exit= from studio-shell
	\item \verb= make lms-shell=
	\item Install xblock as mentioned before
	\item \verb=exit= from lms-shell
	\item \verb=make studio-restart && make lms-restart=
\end{enumerate}

\section{Working}
AdvancedHTMLXBlock essentially extends raw HTML component of Open edX. This Xblock uses
the latest version of CodeMirror(5.38 as of June 2018). The Editor is configured to enable code folding/
code indentation etc. All the html content received from the editor is then put into an iframe. The
height of the iframe is changed on changes in html content and iframe is styled so that it looks
virtually absent.

\section{Technical Details}
Fields :
\begin{enumerate}
\item \textbf{display\_name} : This is the name shown to user(course creator) in “Advanced” component
list in studio
\item \textbf{htmlcontent} : This is the actual htmlcontent that will be rendered to student in student\_view
\item \textbf{live\_preview}: This stores the live preview preference of each xblock
\item \textbf{unique\_id} : This is the id used in student\_view’s html to differentiate from other xblocks.
This is NOT the unique id generated by Open edX platform(also known as locator). This
unique\_id is used as id of iframe in html template. Since this is unnique to each
advancedhtmlblock, you can add multiple advanced html xblocks on same page.
\item Rest fields are just the required fields for the xblock to be used successful in lms and studio
and do not hold much of significance
\end{enumerate}
Functions :
\begin{enumerate}
\item \textbf{student\_view} : \\
This is the function called by LmsRuntime to render the xblock to students.
Since the xblock does not explicitly define author\_view, student\_view is used as
author\_view. On the first run, this will generate unique\_id using uuid library. This id is
passed to student\_view template everytime student\_view is called. The student\_view is
nothing but a simple iframe with NO content inside it initially. Javascript will ask for
htmlcontent once it is initialized. Javascript queries the htmlcontent via AJAX and the
response is JSON. This htmlcontent is then written into iframe by javascript. Once the
content loads inside the iframe, height required for iframe is calculated and then that height
is set to the iframe rendering as if the iframe is absent.
\item \textbf{studio\_view} : \\
This is the editor panel that is shown to course creator in studio after “edit”
button is clicked. The function adds all the requrired CSS and JavaScript required for
CodeMirror to work properly. The interface of studio\_view also consists of a live preview
panel and Advanced Settings panel. Advanced Settings panel allows course creator to hide
live preview panel and change display name of xblock.
\end{enumerate}

\section{Screenshots and Source Code}
\begin{itemize}
\item The screenshots of our Workbench along with the editor are provided as mentioned below
\begin{center}\textbf{[See Figures 9-11 in the “Figures and Screenshots” section.]}\end{center}
\item The screenshots of our Advanced HTML XBlock in our running instance of Open edX are
provided as mentioned below:
\begin{center}\textbf{[See Figures 12-20 in the “Figures and Screenshots” section.]}\end{center}
\item The source code of our Advanced HTML XBlock is available on our github repository as
mentioned below:\newline
\begin{center}[\url{https://github.com/ashutoshbsathe/AdvancedHTMLXBlock}]\end{center}
\end{itemize}

\section{Testing} 
We have tested our xblock to see if we can include multiple xblock in a unit, move/copy an xblock from one unit to another unit, importing/exporting a course with our xblock \newline
We have also tested if all HTML tags/CSS styling and JS is working \newline 
JavaScript has one restriction that it cannot access the topmost window for security reasons. This is tested and it works good so far. \newline\newline
Full test report can be found here : \newline 
\begin{small}
\url{https://docs.google.com/spreadsheets/d/11XM9PDOGZzXspLcwYCWpo9gYTPaiNUo_MKtTmz873sM/edit#gid=0}
\end{small}


\section{Issues and solutions}
\begin{itemize}
	\item \textbf{Broken codemirror features :}\newline
The codemirror source was stripped down to include only the features we need. So it was
tricky to include them in the xblock. However, understanding codemirror code helped us
include it nicely
	\item \textbf{CodeMirror conflicts :}\newline
This issue was not faced on local workbench, we faced this issue when we integrated our
xblock in devstack. The problem was studio and lms already have a version of CodeMirror
loaded with them, so loading our version alongside with it was going to be a problem. We
modified a bit of codemirror source code to make it work in “browser only” mode.
This also brings us to the important conclusion about fragment API. The xblock’s html, CSS
and JavaScript is rendered into a fragment which is then rendered by studio/lms. The catch
is the fragments are not separate from each other. That means one fragment’s CSS/JS can
interfere with another fragment’s CSS/JS and in usual, can interfere with main CSS and JS
used by page. This is potentially dangerous as it can execute some bad code which can break
the entire page.
	\item \textbf{JavaScript Security concerns :}\newline
While our xblock can allow you to add html and css to beautify your course, it will also
allow you to add javascript to your course content to make it interactive. The security
concern was scope of javascript. The scope of javascript must be limited to iframe and
iframe ONLY. Xblock’s javascript in no way should be allowed to access toplevel window.
This was fixed by “sandboxing” the iframe and allowing limited javascript functionalities.
Check out this for more info :\newline
\begin{center}[Commit hash : 3a9d7e3890aa3da834be1d335f4ab799b6629cf3]\end{center}
\begin{center} OR Click below \end{center}
\begin{center}
\begin{tiny}\url{https://github.com/ashutoshbsathe/AdvancedHTMLXBlock/commit/3a9d7e3890aa3da834be1d335f4ab799b6629cf3}\end{tiny}
\end{center}
\end{itemize}